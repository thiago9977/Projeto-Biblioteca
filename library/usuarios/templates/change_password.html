{% extends 'base.html' %}
{% load static %}

{% block title %}Alterar Senha{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-lock"></i> Alterar Senha
                    </h3>
                </div>
                <div class="card-body">
                    <!-- Mensagens de erro/sucesso -->
                    {% if messages %}
                        {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        {% endfor %}
                    {% endif %}

                    <!-- Formulário -->
                    <form method="post" novalidate>
                        {% csrf_token %}
                        
                        <!-- Senha Atual -->
                        <div class="mb-3">
                            <label for="{{ form.old_password.id_for_label }}" class="form-label">
                                {{ form.old_password.label }}
                            </label>
                            <input 
                                type="password" 
                                name="{{ form.old_password.name }}"
                                class="form-control {% if form.old_password.errors %}is-invalid{% endif %}"
                                id="{{ form.old_password.id_for_label }}"
                                placeholder="Digite sua senha atual"
                                required
                            >
                            {% if form.old_password.errors %}
                                <div class="invalid-feedback">
                                    {{ form.old_password.errors.0 }}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Nova Senha -->
                        <div class="mb-3">
                            <label for="{{ form.new_password1.id_for_label }}" class="form-label">
                                {{ form.new_password1.label }}
                            </label>
                            <input 
                                type="password" 
                                name="{{ form.new_password1.name }}"
                                class="form-control {% if form.new_password1.errors %}is-invalid{% endif %}"
                                id="{{ form.new_password1.id_for_label }}"
                                placeholder="Digite sua nova senha"
                                required
                            >
                            {% if form.new_password1.help_text %}
                                <small class="form-text text-muted">{{ form.new_password1.help_text }}</small>
                            {% endif %}
                            {% if form.new_password1.errors %}
                                <div class="invalid-feedback">
                                    {{ form.new_password1.errors.0 }}
                                </div>
                            {% endif %}
                            <!-- Indicador de força da senha -->
                            <div id="password-strength" class="mt-2"></div>
                        </div>

                        <!-- Confirmar Nova Senha -->
                        <div class="mb-3">
                            <label for="{{ form.new_password2.id_for_label }}" class="form-label">
                                {{ form.new_password2.label }}
                            </label>
                            <input 
                                type="password" 
                                name="{{ form.new_password2.name }}"
                                class="form-control {% if form.new_password2.errors %}is-invalid{% endif %}"
                                id="{{ form.new_password2.id_for_label }}"
                                placeholder="Confirme sua nova senha"
                                required
                            >
                            {% if form.new_password2.errors %}
                                <div class="invalid-feedback">
                                    {{ form.new_password2.errors.0 }}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Erros não relacionados a campos específicos -->
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}

                        <!-- Botões -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Alterar Senha
                            </button>
                            <a href="{% url 'usuarios:profile' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left"></i> Voltar
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Dicas de segurança -->
            <div class="card mt-3">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="fas fa-info-circle"></i> Dicas para uma senha segura:
                    </h6>
                    <ul class="small mb-0">
                        <li>Use no mínimo 8 caracteres</li>
                        <li>Combine letras maiúsculas e minúsculas</li>
                        <li>Inclua números e caracteres especiais (@, #, $, etc.)</li>
                        <li>Não use informações pessoais óbvias</li>
                        <li>Não reutilize senhas de outros sites</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript para indicador de força da senha -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const passwordInput = document.getElementById('{{ form.new_password1.id_for_label }}');
    const strengthDiv = document.getElementById('password-strength');
    
    if (passwordInput) {
        passwordInput.addEventListener('input', function() {
            const password = this.value;
            const strength = calculatePasswordStrength(password);
            showPasswordStrength(strength);
        });
    }
    
    function calculatePasswordStrength(password) {
        let strength = 0;
        
        if (password.length >= 8) strength++;
        if (password.length >= 12) strength++;
        if (password.match(/[a-z]+/)) strength++;
        if (password.match(/[A-Z]+/)) strength++;
        if (password.match(/[0-9]+/)) strength++;
        if (password.match(/[^a-zA-Z0-9]+/)) strength++;
        
        return strength;
    }
    
    function showPasswordStrength(strength) {
        const messages = {
            0: { text: 'Muito fraca', color: 'danger', width: '20%' },
            1: { text: 'Muito fraca', color: 'danger', width: '20%' },
            2: { text: 'Fraca', color: 'warning', width: '40%' },
            3: { text: 'Razoável', color: 'info', width: '60%' },
            4: { text: 'Boa', color: 'primary', width: '80%' },
            5: { text: 'Forte', color: 'success', width: '100%' },
            6: { text: 'Muito forte', color: 'success', width: '100%' }
        };
        
        const level = messages[strength] || messages[0];
        
        strengthDiv.innerHTML = `
            <small class="text-muted">Força da senha:</small>
            <div class="progress" style="height: 5px;">
                <div class="progress-bar bg-${level.color}" 
                     role="progressbar" 
                     style="width: ${level.width}" 
                     aria-valuenow="${strength}" 
                     aria-valuemin="0" 
                     aria-valuemax="6">
                </div>
            </div>
            <small class="text-${level.color}">${level.text}</small>
        `;
    }
});
</script>
{% endblock %}